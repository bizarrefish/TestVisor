<!DOCTYPE html>
<html>
	<head>
		<title>TestVisor</title>
		<link rel="stylesheet" type="text/css" href="style.css" ></link>
	</head>
	<body>
		<header>
			<h1><img src="visor.png"></img><span id="headerText">Page Title Here</span></h1>
			<div style="float:right"><div><br><br><br><br></div></div>
		</header>
		<div class="navBar"></div>

		<!-- Home -->
		<div id="homeView" class="view">
			<div class="heading" style="display:none">Home</div>
			<div id="homeModule" class="module">
				<div class="heading">Test Visor</div>
				<div>Welcome to testVisor</div>
			</div>
		</div>
		
		<!-- Test Plans -->
		<div id="testPlanView" class="view">
			<div class="heading" style="display:none">Test Plans</div>
			
			
			<div style="width:20%;float:left">
				<div id="testPlanListModule" class="module">
					<div class="heading">Test Plans</div>
					<br>
					<div id="testPlanList"></div>
				</div>
			</div>
			
			<div style="width:80%;float:left">
				<div id="testPlanEditor" class="module">
					<div class="heading"></div>
					<div style="text-align:left">
						<input type="button" value="Save" id="testPlanSaveButton"></input>
						<input type="button" value="Run" id="testPlanRunButton"></input>
					</div>
					<textarea id="testPlanEditorArea"></textarea>
					
				</div>
			</div>

		</div>
		
		<!-- Test Runs -->
		<div id="resultsView" class="view">
			<div class="heading" style="display:none">Test Results</div>
			<div id="testRunListModule" class="module" style="width:30%;float:left;">
				<div class="heading">Test Runs</div>
				<br>
				<div>
					<div style="float:right"><input type="button" value="Next Page >" id="nextResults"></input></div>
					<div style="float:left"><input type="button" value="< Previous Page" id="prevResults"></input></div>
				</div>
				<br>
				<div id="testRunList" class="divList"></div>
				<div id="testRunListDesc" class="desc">Test Results</div>
			</div>
			
			<!-- Test Results -->
			<div id="resultsContainer" style="float:left; width:50%;">
				<div id="testResultListModule" class="module">
					<div id="resultListHeading" class="heading">Results</div>
					<div id="testResultList" class="divList"></div>
				</div>
				
				<div id="testResultModule" class="module">
					<div id="resultHeading" class="heading">Details</div>
					<div id="testResult" class="divList"></div>
					<br>
					<div id="artifactListHeading" class="heading">Artifacts</div>
					<div id="artifactList" class="divList"></div>
				</div>
			</div>
		</div>
		
		<div class="view" id="testView">
			<div class="heading" style="display:none">Test</div>
			<div class="testList">
				<div>Plan1</div>
				<div>Plan2</div>
				<div>Plan3</div>
			</div>
			'
			<div class="testContent">
				<h1>Test Stuff</h1>
				<br><br><br><br><br>
			</div>
		</div>
		
		<script type="text/javascript" src="jquery-1.7.2.min.js"></script>
		<script type="text/javascript" src="edit_area/edit_area_full.js"></script>
		<script type="text/javascript" src="divList.js"></script>
		<script type="text/javascript" src="statusBox.js"></script>
		<script type="text/javascript" src="navBar.js"></script>
		<script type="text/javascript" src="module.js"></script>
		<script type="text/javascript" src="views.js"></script>
		<script type="text/javascript">
			// The ajax function
			function ajax(uri, params, callback)
			{
				 $.ajax({
				 	url: uri,
				 	dataType: "json",
				 	data: JSON.stringify(params),
					type: "POST",
					processData: false,
					contentType: "application/json"
				 }).done(function(data, status) {
				 	if(status === "success") callback(data);
				 });
			}
		</script>
		<script type="text/javascript" src="ajax.js"></script>
		<script type="text/javascript">
			$(document).ready(function() {
			
				
				var idctr = 0;
				
				// Initialize modules		
				Module_Add("homeModule");
				Module_Add("testPlanListModule");
				Module_Add("testPlanInfoModule");
				Module_Add("testPlanEditor");
				Module_Add("testRunListModule");
				Module_Add("resultsContainer");
				
				// Initalize views
				Views_Init();
				
				var testPlanMap = {};
				
				Views_OpenFunction("testPlanView", function() {
					var idctr = 0;
					
					var currentTestPlanId;
					
					function LoadTestPlanSource(id) {
						Plans_GetSource({TestPlanId: id}, function(source) {
							editAreaLoader.setValue("testPlanEditorArea", source)
							currentTestPlanId = id;
						});
						
						DivList_Select("div#testPlanList", "plan-" + id);
					}
					
					function SaveTestPlanSource() {
						Plans_SetSource({
							TestPlanId: currentTestPlanId,
							Source: editAreaLoader.getValue("testPlanEditorArea")
						}, function() {
							alert("Saved");
						});
					}
					
					$("#testPlanSaveButton").unbind('click').click(SaveTestPlanSource);
					
					$("#testPlanRunButton").unbind('click').click(function() {
						Plans_Start({
							TestPlanId: currentTestPlanId,
							Arguments: {}
						}, function() {
						
						});
					});
					
					function AddPlan(testPlan) {
						DivList_Add("div#testPlanList", "plan-" + testPlan.Id, testPlan.Name, testPlan.Description, "visor.png", function() {
							$("#testPlanEditor > .heading").text(testPlan.Name);
							LoadTestPlanSource(testPlan.Id);
						});
					}
					
					function NewTestPlan() {
						var name = window.prompt("Name of new test plan", "");
						if(name !== "") {
							Plans_Create({
								Info: { Name: name, Description: name }
							}, function() {
								RefreshTestPlanList();
							});
						}
					}
					
					editAreaLoader.init({
						id : "testPlanEditorArea"		// textarea id
						,syntax: "js"			// syntax to be uses for highgliting
						,start_highlight: true		// to display with highlight mode on start-up
					})
					
					function RefreshTestPlanList() {
					
						DivList_Clear("div#testPlanList");
						Plans_GetTestPlans({}, function(testPlans) {
							for(var i in testPlans) {
								var obj = testPlans[i];
								AddPlan(obj);
							}
							DivList_Add("div#testPlanList", "addnewplan", "Add New...", "Create a new test plan", "plus.png", NewTestPlan);
						});
					}
					
					RefreshTestPlanList();
				});
				
				Views_OpenFunction("resultsView", function() {
					var idctr = 0;
					var resStart = 0;
					var resLimit = 5;
					
					function AddResultDetail(name, value)
					{
						DivList_Add("div#testResult", "part-" + (idctr++), name, value)
					}
					
					function AddArtifact(obj)
					{
						DivList_Add("div#artifactList", "artifact-" + (idctr++), obj.Name, obj.FileName);
					}
					
					function UpdateResult(testKey, obj)
					{
						DivList_Clear("div#testResult");
						DivList_Clear("div#artifactList");
						
						$("div#resultHeading").text(testKey + " Details");
						$("div#artifactHeading").text(testKey + " Artifacts");
						
						AddResultDetail("Success", obj.Result.Success);
						AddResultDetail("Execution Time", obj.Result.ExecutionTime);
						
						for(var i in obj.Artifacts)
						{
							AddArtifact(obj.Artifacts[i])
						}
					}
					
					function AddTestResult(testKey, obj) {
						var id = "result-" + (idctr++)
						DivList_Add("div#testResultList", id, testKey, testKey, "visor.png", function() {
							DivList_Select("div#testResultList", id);
							UpdateResult(testKey, obj);
						});
						return id;
					}
					
					function UpdateResultsList(testRun) {
						$("div#resultsContainer").fadeOut(function() {
							$("div#resultListHeading").text(testRun.Name);
							
							DivList_Clear("div#testResultList");
							DivList_Clear("div#testResults, div#artifactList");
							
							var first = true;
							for(var testKey in testRun.Results) {
								var result = testRun.Results[testKey];
								var id = AddTestResult(testKey, result);
								DivList_Select("div#testResultList", id);
								UpdateResult(testKey, result);
								first = false;
							}
							$("div#resultsContainer").fadeIn();
						});
					}
					
					function AddTestRun(obj) {
						var id = "run-" + (idctr++)
						DivList_Add("div#testRunList", id, obj.Name, obj.Description, "visor.png", function() {
							UpdateResultsList(obj);
							DivList_Select("div#testRunList", id);
						});
					}
					
					function UpdateRunsList(start, limit, testPlan) {
						resStart = start;
						resLimit = limit;
						testPlanId = testPlan;
						
						DivList_Clear("div#testRunList");
						DivList_Add("div#testRunList", "loading-runs", "Loading Runs...", "");
						Results_GetTestResults({
							Skip: start,
							Limit: limit,
							TestPlanId: testPlan
						}, function(results) {
							DivList_Clear("div#testRunList")
							for(var i in results)
							{
								AddTestRun(results[i]);
							}
							
							$("div#testRunListDesc").text("Showing results: " + start + " to " + (start + limit - 1));
						});
					}
					
					var testPlanId = "lol";
					
					
					$("input#nextResults").unbind("click").click(function() {
						UpdateRunsList(resStart + resLimit, resLimit, testPlanId);
					});
					
					$("input#prevResults").unbind("click").click(function() {
						var newStart = resStart - resLimit;
						if(newStart < 0) newStart = 0;
						UpdateRunsList(newStart, resLimit, testPlanId);
					});
					
					UpdateRunsList(0, resLimit, testPlanId);
					
				});
				
			});
		</script>
	</body>
</html>
